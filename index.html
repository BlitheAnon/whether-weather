<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>whether weather</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/weather-icons.min.css">
    <script type="text/javascript" src="city/city.json"></script>
</head>

<body>
    <!-- 顶部搜索栏 -->
    <header>
        <div>
            <i class="fa fa-search fa-lg"></i>
            <input type="text" name="" value="" placeholder="输入中文城市名搜索">
            <i id="ipt_delete" class="fa fa-times-circle fa-lg" onclick="removeIput()"></i>
        </div>
    </header>

    <main>
        <div class="main-top">
            <span class="main-left">
                <i class="fa fa-map-marker fa-lg"></i>
                <span id="now_city">-</span>
            </span>
            <span class="main-right">
                <span id="update_time">--:--</span>
                <span>更新</span>
            </span>
        </div>

        <div class="main-main">
            <span id="now_tem">-</span>
            <span>
                <span id="now_wea">-</span>
                <span>/</span>
                <span id="now_win">-</span>
            </span>
            <span id="now_air_container">
                <span id="now_air">-</span>
                <span id="now_air_level">-</span>
            </span>
        </div>

        <div class="main-bottom">
            <span class="main-left">
                <span>今天:</span>
                <span id="now_today_wea">-</span>
            </span>
            <span class="main-right">
                <span id="now_low_tem">-</span>~<span id="now_high_tem">-</span>°C
            </span>
        </div>
    </main>

    <footer>
        <!-- <div class="square">
                <i class="wi wi-day-sunny"></i>
                <div>
                    <span>北京</span>
                    <span>/</span>
                    <span>阴</span>
                </div>
                <div>23°C</div>
            </div> -->
    </footer>

    <!-- 取得访问者ip -->
    <script src="https://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script type="text/javascript" src="js/match.js"></script>
    <script type="text/javascript">
        function removeIput() {
            //清除输入
            document.getElementsByTagName('input')[0].value = '';
        }

        //生成当前天气
        function initNowWeather(response) {
            console.log(response);
            //填充数据
            //1.now_city，当前地区
            //2.update_time，更新时间
            //3.now_tem，当前温度
            //4.now_wea，当前天气情况
            //5.now_win，当前风级
            //6.now_air，当前空气指数
            //7.now_air_level，当前空气描述
            //8.now_today_wea，今日天气
            //9.now_low_tem，今日最低气温
            //10.now_high_tem，今日最高气温
            //console.log(response.city);
            document.getElementById('now_city').innerText = response.city;
            document.getElementById('update_time').innerText = response.update_time;
            document.getElementById('now_tem').innerText = response.tem;
            document.getElementById('now_wea').innerText = response.wea;
            document.getElementById('now_win').innerText = response.win + response.win_speed;
            let className=airMatch(response.air_level);
            //设置空气质量背景色
            document.getElementById('now_air_container').classList.add(className);
            document.getElementById('now_air').innerText = response.air;
            document.getElementById('now_air_level').innerText = response.air_level;
            document.getElementById('now_today_wea').innerText = response.wea;
            document.getElementById('now_low_tem').innerText = response.tem2;
            document.getElementById('now_high_tem').innerText = response.tem1;
        }

        //输入后，新增天气
        function addNewCity(response) {
            //保存response
            let wea_json = sessionStorage.getItem('wea_json');
            if (!wea_json) {
                //console.log('null');
                let new_wea_json=JSON.stringify([response]);
                sessionStorage.setItem('wea_json',new_wea_json);
            }else{
                //console.log('new json');
                //判断城市是否已存在
                let wea_json_object=JSON.parse(wea_json);
                wea_json_object.push(response);
                sessionStorage.setItem('wea_json',JSON.stringify(wea_json_object));
            }
            var footer = document.getElementsByTagName('footer')[0];
            //取得数据
            //1.new_city，新增地区
            //2.city_tem，地区温度
            let node = document.createElement('div');
            node.setAttribute('class', 'square');
            //自定义属性传入cityid
            node.setAttribute("cityid", response.cityid);
            //匹配天气图标
            let wea_logo = logoMatch(response.wea_img);
            node.innerHTML = '<i class="wi ' + wea_logo + '"></i><div><span>' + response.city + '</span><span>/</span><span>' + response.wea + '</span></div><div>' + response.tem + '°C</div>';
            //给底部城市列表添加点击事件
            node.addEventListener('click', function(event) {
                //取得cityid
                let cityid = this.getAttribute('cityid');
                //取得已保存的匹配天气数据
                let wea_json=sessionStorage.getItem('wea_json');
                //匹配当前城市
                let now_city=JSON.parse(wea_json).filter((item)=>{
                    return item.cityid==cityid;
                })

                initNowWeather(now_city[0]);
            });
            footer.appendChild(node);
        }



        window.onload = function() {
            var footer = document.getElementsByTagName('footer')[0];
            //设置天气个数
            // var cityCount = 0;
            // for (var i = 0; i < cityCount; i++) {
            //     var node = document.createElement('div');
            //     node.setAttribute('class', 'square');
            //     node.innerHTML = '<i class="wi wi-day-sunny"></i><div>北京</div><div>23</div>';
            //     footer.appendChild(node);
            // }

            //jsonp方式通过客户端ip取得本地天气
            function loadWeatherByIP(_ip) {
                let script = document.createElement("script");
                script.src = 'https://www.tianqiapi.com/api?' + 'version=v6&ip=' + _ip + '&callback=initNowWeather';
                document.body.insertBefore(script, document.body.firstChild);
            }

            let _userIP = returnCitySN["cip"];
            loadWeatherByIP(_userIP);


            //监听input，回车事件
            document.getElementsByTagName('input')[0].addEventListener('keypress', function(e) {
                var key = e.which || e.keyCode;
                if (key === 13) { // 13 is enter
                    let inputCity = document.getElementsByTagName('input')[0].value.trim();
                    //回车后新增一个城市
                    if (!(inputCity == '')) {
                        searchCity(inputCity);
                        //addNewCity(inputCity);
                    }
                }
            });

            function searchCity(_input) {
                //按输入匹配json内城市
                var citydata = JSON.parse(city);

                let resultCity = citydata.filter((item) => {
                    if (item.cityZh == _input) {
                        return item;
                    }
                })

                if (resultCity.length == 0) {
                    alert("查找城市不存在");
                } else {
                    //检查城市是否已添加
                    if (checkCityExit(resultCity[0].id)) {
                        alert('城市已添加');
                    }else{
                        //alert(resultCity[0].id + resultCity[0].cityEn);
                        loadWeatherByID(resultCity[0].id);
                    }
                }
            }

            function checkCityExit(_id) {
                let city_json=JSON.parse(sessionStorage.getItem('wea_json'));
                if (city_json) {
                    let checkResult=city_json.filter((item)=>{
                        return item.cityid==_id;
                    })

                    return checkResult.length==1;
                }else{
                    return false;
                }
            }

            //jsonp方式通过地区id取得天气
            function loadWeatherByID(_id) {
                let script = document.createElement("script");
                script.src = 'https://www.tianqiapi.com/api?' + 'version=v6&cityid=' + _id + '&callback=addNewCity';
                document.body.insertBefore(script, document.body.firstChild);
            }

            //监听点击城市列表项
            //let cityList = document.getElementsByClassName('square');
            // document.querySelector('footer').addEventListener('click', function(event) {
            //     console.log('work');
            //     console.log(event.target.tagName);
            //     if (event.target.tagName.toLowerCase() === 'div') {
            //         // do your action on your 'li' or whatever it is you're listening for
            //         alert('test');
            //     }
            // },false);
            // for (item of cityList) {
            //     item.addEventListener('click', () => {
            //         alert('test');
            //     });
            // }


            //监听输入，显示城市列表
        }
    </script>
</body>

</html>
