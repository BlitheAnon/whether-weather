(()=>{"use strict";const t=async t=>new Promise(((e,s)=>{const r=new XMLHttpRequest;r.onload=()=>{e(r.responseText)},r.onerror=()=>{s(new Error("Local request failed"))},r.open("GET",t),r.send()})),e=async e=>JSON.parse(await t(e)),s=new Map,r=async(t,r)=>{const i=`${t}/assets/locales/${r}.json`;if(!s.has(i)){const t=await e(i);t&&s.set(i,t)}return s.get(i)},i=(t,e,s=0,r=0)=>new Intl.NumberFormat(t,{minimumFractionDigits:s,maximumFractionDigits:r}).format(e),n=t=>(e,s,r)=>{const n=new RegExp(`{${s},[ ]*number}`,"g");return e.replaceAll(n,i(t,+r))},a=(t,e,s)=>{const r=new RegExp(`{${e}, plural, .+?}}`,"g");let i=new RegExp("=0[ ]*{(.*?)}","g");const n=+s;1===n?i=new RegExp("one[ ]*{(.*?)}","g"):n>1&&(i=new RegExp("other[ ]*{(.*?)}","g"));const a=i.exec(t);return a?t.replaceAll(r,a[1].replace("#",s)):t},o=(t,e,s)=>t.replaceAll(`{${e}}`,s),l=(t,e,s)=>{const r=new RegExp(`{${e}, select, .+?}[ ]*}`,"g"),i=new RegExp(`${s}[ ]*{(.*?)}`,"g").exec(t);return i?t.replaceAll(r,i[1]):t},c=async(t,e,s,i,c=!1)=>{let h,d;try{if(h=await r(t,e),!h)throw new Error(`Could not find ${e} object`)}catch(e){h=await r(t,"en-GB")}return h?(d=c?h[s]:s.split(".").reduce(((t,e)=>t[e]),h),d&&((t,e,s)=>{if(!e||!s)return e;const r=[n(t),a,o,l];return Object.entries(s).reduce(((t,[e,s])=>r.reduceRight(((t,r)=>r(t,e,s)),t)),e)})(e,d,i)||s):s},h=t=>e=>{customElements.get(t.selector)||customElements.define(t.selector,e)};var d;!function(t){t.MPN="mpn",t.GTIN="gtin",t.SKU="sku"}(d||(d={}));const p=d;class T{identifiers;type;constructor(t,e,s){if(t)this.identifiers=t,this.type=p.SKU;else if(e)this.identifiers=e,this.type=p.GTIN;else{if(!s)throw new Error("No product identifier data attribute found.");this.identifiers=s,this.type=p.MPN}}getIdentifiers(){return this.identifiers}getEncodedIdentifiers(){return this.type===p.SKU?this.identifiers.map((t=>(t=>{const e=unescape(encodeURIComponent(t));let s="";for(let t=0;t<e.length;t++)s+=e.charCodeAt(t).toString(16);return s})(t))):this.identifiers}getType(){return this.type}}const u="$_PRODUCT_IDENTIFIER",E=async t=>{const s=await e(t);if("object"==typeof s&&0===Object.keys(s).length)throw new Error("Server returned empty object!");return s},m=async(t,e,s)=>{const r=t.replace("$_PRODUCT_IDENTIFIER_TYPE",e).replace(u,s);return E(r)},g=["oneStar","twoStars","threeStars","fourStars","fiveStars"];var A;let v=A=class extends HTMLElement{keyboardNavigationOrder;ATTRIBUTE_BASE_URL="baseUrl";ATTRIBUTE_LOCALE="locale";ATTRIBUTE_ACCENT_COLOR="data-accent-color";DEFAULT_ACCENT="#DB6B22";baseUrl;locale;accentColor;_popoverData;rootElement;renderTimeout;hasRendered;innerWidthBefore=window.innerWidth;get popoverData(){return this._popoverData}set popoverData(t){this._popoverData=t,this.render()}constructor(t){super(),this.keyboardNavigationOrder=t}async connectedCallback(){this.baseUrl=this.getAttribute(this.ATTRIBUTE_BASE_URL)||"",this.locale=this.getAttribute(this.ATTRIBUTE_LOCALE)||"en-GB",this.accentColor=this.getAttribute(this.ATTRIBUTE_ACCENT_COLOR)||this.DEFAULT_ACCENT,this.attachShadow({mode:"open"}),this.addCssStyle(this.baseUrl),this.style.setProperty("--accent-color",this.accentColor),this.rootElement=this.addRootElement()}async disconnectedCallback(){if(this.hasRendered)return this.keyboardNavigationOrder.removeLastElement(),void this.keyboardNavigationOrder.removeLastElement();clearTimeout(this.renderTimeout)}static getPercentageBar(t,e,s,r){return`\n      <div class="distribution-row">\n        <span class="rating-index" aria-label="${t}">\n          ${t}\n          <span class="rating-star" aria-label="${r.replace(/"/g,"&quot;")}"><img class="star"></span>\n        </span>\n        <div class="bar" aria-label="${s.replace(/"/g,"&quot;")}">\n          <div class="bar-filled" style="width: ${e}%"></div>\n        </div>\n        <span class="percent"> ${e}% </span>\n      </div>\n    `}handleMargins=()=>{let t=0;const e=this.rootElement.querySelector(".popover"),s=this.rootElement.querySelector(".arrow");if(e&&s){const{left:r,right:i}=e.getBoundingClientRect(),n=this.innerWidthBefore,a=10;r-a<=0?t=-r+a:i+a>=n&&(t=-(i-n+a)),e.style.marginLeft=`${t}px`,s.style.marginLeft=-t+"px"}};addCssStyle(t){const e=document.createElement("style");e.setAttribute("type","text/css"),e.innerHTML=`@import "${t}/index.css"`,this.shadowRoot?.appendChild(e)}addRootElement(){const t=document.createElement("div");return t.classList.add("popover-wrapper"),this.shadowRoot?.appendChild(t),t}async render(){if(!this.popoverData)return;const{grade:t}=this.popoverData,e=t.distribution,s=t.count,r=[e.oneStar,e.twoStars,e.threeStars,e.fourStars,e.fiveStars].map((t=>{return e=t,r=s,isNaN(e)||0===r?0:Math.round(100*e/r);var e,r})),n=await c(this.baseUrl,this.locale,"barAriaLabel"),a=await c(this.baseUrl,this.locale,"ratingAriaLabel"),o=r.map(((t,e)=>A.getPercentageBar(e+1,t,n,a))).reverse(),l=await c(this.baseUrl,this.locale,"totalReviewCount",{totalReviewCount:i(this.locale,s)}),h=await c(this.baseUrl,this.locale,"legalText"),d=await c(this.baseUrl,this.locale,"legalText2"),p=await c(this.baseUrl,this.locale,"logoAriaLabel");this.renderTimeout=setTimeout((()=>{this.rootElement.innerHTML=`\n        <div class="popover">\n          <div class="arrow"></div>\n          <div class="header">\n            <span class="rating">\n              ${i(this.locale,t.rating,2,2)}\n            </span>\n            <span class="review-count"> ${l} </span>\n            <span class="logo" aria-label="${p.replace(/"/g,"&quot;")}">\n              <img class="logo-img">\n            </span>\n          </div>\n          <div class="body">${o.join("")}</div>\n          <div class="footer">\n            <span>${h}</span>\n            <span>${d}</span>\n          </div>\n        </div>\n      `,this.handleMargins();const e=this.rootElement.querySelectorAll("a")||[];this.keyboardNavigationOrder.addElements(Array.from(e)),this.keyboardNavigationOrder.addListener(this),this.hasRendered=!0}),300)}};var f;v=A=function(t,e,s,r){var i,n=arguments.length,a=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,r);else for(var o=t.length-1;o>=0;o--)(i=t[o])&&(a=(n<3?i(a):n>3?i(e,s,a):i(e,s))||a);return n>3&&a&&Object.defineProperty(e,s,a),a}([h({selector:"etrusted-ps-popover"})],v),function(t){t.OS="os",t.LIGHT="light",t.DARK="dark"}(f||(f={}));const R=f;var w;!function(t){t.DEFAULT="default",t.INHERIT="inherit"}(w||(w={}));const b=w;let L=class extends HTMLElement{ATTRIBUTE_BASE_URL="baseUrl";ATTRIBUTE_LOCALE="locale";ATTRIBUTE_RATING="rating";MIN_GRADE=0;MAX_GRADE=5;baseUrl;locale;async connectedCallback(){this.baseUrl=this.getAttribute(this.ATTRIBUTE_BASE_URL)||"",this.locale=this.getAttribute(this.ATTRIBUTE_LOCALE)||"en-GB";const t=+(this.getAttribute(this.ATTRIBUTE_RATING)??0);this.validate(t)&&await this.render(t)}validate(t){return!(isNaN(t)||t<this.MIN_GRADE||t>this.MAX_GRADE)}async render(t){const e=Math.floor(t),s=t%1*100,r='<div class="empty"></div>',n='<div class="filled"></div>',a=await c(this.baseUrl,this.locale,"starRatingAriaLabel",{rating:i(this.locale,t)});this.innerHTML=`\n      <div class="star-rating" aria-label="${a.replace(/"/g,"&quot;")}">\n        ${n.repeat(e)}\n        ${e!==this.MAX_GRADE?`\n              <div class="star-rating__fraction">\n                <div class="star">\n                  ${r}\n                </div>\n                <div class="star" style="width: ${s}%">\n                  ${n}\n                </div>\n              </div>\n              ${r.repeat(this.MAX_GRADE-e-1)}\n            `:""}\n      </div>\n    `}};L=function(t,e,s,r){var i,n=arguments.length,a=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,r);else for(var o=t.length-1;o>=0;o--)(i=t[o])&&(a=(n<3?i(a):n>3?i(e,s,a):i(e,s))||a);return n>3&&a&&Object.defineProperty(e,s,a),a}([h({selector:"etrusted-ps-star-rating"})],L);class _{elementList;currentIndex;constructor(t){this.setOrder(t,0)}setCurrentIndex(t){this.currentIndex=t}setOrder(t,e){this.elementList=t,this.currentIndex=e}addElements(t){this.setOrder([...this.elementList,...t],this.currentIndex)}removeLastElement(){0===this.currentIndex&&this.focusNextElement(),this.elementList.pop()}addListener(t){t.addEventListener("keydown",(t=>this.keyDownListener(t)))}keyDownListener(t){if("Tab"===t.key){if(!t.shiftKey){if(this.focusNextElement())return t.preventDefault();this.elementList[0].focus()}if(t.shiftKey&&this.focusPrevElement())return t.preventDefault()}}focusNextElement(){const t=this.currentIndex+1;if(t>=this.elementList.length)return;this.currentIndex=t;const e=this.elementList[this.currentIndex];return e.focus(),e}focusPrevElement(){const t=this.currentIndex-1;if(t<0)return;this.currentIndex=t;const e=this.elementList[this.currentIndex];return e.contentEditable="true",e.focus(),e.contentEditable="false",e}}new _([]);var y;let C=y=class extends HTMLElement{CURRENT_MAJOR_VERSION="v1";QUERY_SELECTOR_PROPS='script[type="text/props"]';ATTRIBUTE_LOCALE="data-etrusted-locale";ATTRIBUTE_THEME="data-theme";ATTRIBUTE_FONT_STYLE="data-font-style";ATTRIBUTE_ACCENT_COLOR="data-accent-color";DEFAULT_ACCENT_COLOR="#DB6B22";DEFAULT_ACCENT_COLOR_DARK_MODE="#FF8700";ATTRIBUTE_SKU="data-sku";ATTRIBUTE_GTIN="data-gtin";ATTRIBUTE_MPN="data-mpn";rootElement;context;popoverElement;wrapper;osThemeHost=window.matchMedia("(prefers-color-scheme: dark)");mouseOver=!1;keyboardNaivgationOrder=new _([]);themeListener=t=>{this.setToOsStyle(t.matches)};async connectedCallback(){const t=this.getRootNode()?.host||this,e=this.getAttribute(this.ATTRIBUTE_LOCALE),s=this.getAttribute(this.ATTRIBUTE_THEME),r=this.getAttribute(this.ATTRIBUTE_FONT_STYLE),i=this.getAttribute(this.ATTRIBUTE_ACCENT_COLOR),n=this.getManifest();if(!n)return;const a=await E(n.configuration.url),o=this.getAttribute(this.ATTRIBUTE_SKU)?.split(","),l=this.getAttribute(this.ATTRIBUTE_GTIN)?.split(","),c=this.getAttribute(this.ATTRIBUTE_MPN)?.split(","),h=new T(o,l,c),d=await this.getBaseUrl(n.application.url),A=y.getDistributionUrl(n.application.url||d);this.shadowRoot||(this.attachShadow({mode:"open"}),this.addCssStyle(d),this.rootElement=this.addRootElement());const v=await E(n.feeds.channels.url),f=n.dynamicFeeds.gtin_mapping?n.dynamicFeeds.gtin_mapping.url:`${A}/feeds/mappings/gtin/v1/channels/${v.id}/${u}/mapping.json`,w=h.getType()===p.GTIN?await(async(t,e)=>{if(e.getType()!==p.GTIN)throw new Error("Product Identifier needs to be GTIN");const s=await Promise.all(e.getIdentifiers().map((e=>(async(t,e)=>{try{return await m(t,p.GTIN,e)}catch{return}})(t,e)))),r=s.filter((t=>!!t)),i=[...new Set(r.filter((t=>!!t)).map((t=>t.products.map((t=>t.sku)))).flat())];return new T(i)})(f,h):h,L=(t=>{let e=[0,0,0,0,0],s=0,r=0;t.length>0&&(e=g.map((e=>t.map((({distribution:t})=>t[e])).reduce(((t,e)=>e+t),0))),s=t.map((t=>t.count)).reduce(((t,e)=>e+t),0),r=s>0?e.reduce(((t,e,s)=>e*(s+1)+t),0)/s:0);const[i,n,a,o,l]=e;return{count:s,distribution:{fiveStars:l,fourStars:o,threeStars:a,twoStars:n,oneStar:i},rating:r}})((await(async(t,e,s)=>(await Promise.all(s.map((async s=>{try{return await m(t,e,s)}catch{return}})))).filter((t=>!!t)))(n.dynamicFeeds.grades.url,w.getType(),w.getEncodedIdentifiers())).map((t=>t.grades.overall)));this.context={baseUrl:d,manifest:n,theme:s??a.theme??R.LIGHT,fontStyle:r||a.fontStyle||b.DEFAULT,accentColor:i||a.accentColor||this.DEFAULT_ACCENT_COLOR,configuration:{...a,locale:e||a.locale},channel:v,grade:L},a.hideWhenEmpty&&0===L.rating||(this.setAttribute(this.ATTRIBUTE_THEME,this.context.theme),this.setAttribute(this.ATTRIBUTE_FONT_STYLE,this.context.fontStyle),this.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,this.context.accentColor),this.changeAccentColor(),await this.render(),this.setupMutationObserver(t),this.handleOSStyleListener(this.context.theme!==R.OS),this.wrapper?.addEventListener("focusout",(t=>{const e=t.relatedTarget;!this.popoverElement||e&&this.popoverElement.contains(e)||this.hidePopover(this.wrapper)})),this.wrapper?.addEventListener("focus",(()=>this.keyboardNaivgationOrder.setCurrentIndex(0))))}disconnectedCallback(){this.handleOSStyleListener(!0)}getNormalizedAccentColor(t=this.DEFAULT_ACCENT_COLOR){const e=t.toLowerCase()===(this.DEFAULT_ACCENT_COLOR||this.DEFAULT_ACCENT_COLOR_DARK_MODE).toLowerCase(),s=this.getAttribute(this.ATTRIBUTE_THEME)??this.context.theme;return e?s===R.DARK?this.DEFAULT_ACCENT_COLOR_DARK_MODE:this.DEFAULT_ACCENT_COLOR:t}changeAccentColor(){const t=this.getAttribute(this.ATTRIBUTE_ACCENT_COLOR)??this.context.accentColor,e=this.getNormalizedAccentColor(t);this.style.setProperty("--accent-color",e),this.context.accentColor=e}setupMutationObserver(t){const e=new MutationObserver((e=>{t!==this&&(e.forEach((e=>{const s=e.attributeName,r=t.getAttribute(s);if(s===this.ATTRIBUTE_THEME){const t=this.context.theme;this.context.theme=r??this.context.configuration.theme,this.setAttribute(this.ATTRIBUTE_THEME,r),this.handleOSStyleListener(R.OS===t||R.OS!==this.context.theme),this.changeAccentColor()}s===this.ATTRIBUTE_LOCALE&&(this.context.configuration.locale=r,this.setAttribute(this.ATTRIBUTE_LOCALE,r)),s===this.ATTRIBUTE_FONT_STYLE&&(this.context.fontStyle=r,this.setAttribute(this.ATTRIBUTE_FONT_STYLE,r)),s===this.ATTRIBUTE_ACCENT_COLOR&&(this.context.accentColor=r,this.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,r),this.changeAccentColor())})),this.render())}));return e.observe(t,{attributes:!0}),e}setToOsStyle=t=>{this.setAttribute(this.ATTRIBUTE_THEME,t?"dark":"light"),this.changeAccentColor()};handleOSStyleListener(t=!1){if(this.context.theme===R.OS||!t)return this.setToOsStyle(this.osThemeHost.matches),void this.osThemeHost.addEventListener("change",this.themeListener);this.osThemeHost.removeEventListener("change",this.themeListener)}getManifest=()=>{const t=this.querySelector(this.QUERY_SELECTOR_PROPS)?.textContent;return t?JSON.parse(t).manifest:null};showPopover=t=>{if(this.mouseOver=!0,this.wrapper){this.popoverElement||(this.popoverElement=new v(this.keyboardNaivgationOrder),this.popoverElement.onmouseleave=()=>this.hidePopover(this.wrapper));const{top:e,left:s,width:r}=this.wrapper.getBoundingClientRect(),{grade:i,channel:n,baseUrl:a,configuration:o,fontStyle:l,accentColor:c}=this.context,{scrollX:h,scrollY:d}=window;this.popoverElement.style.zIndex="2147483646",this.popoverElement.style.position="absolute",this.popoverElement.style.top=`${e+d}px`,this.popoverElement.style.left=`${s+h}px`,this.popoverElement.style.width=`${r}px`,this.popoverElement.setAttribute("baseUrl",a),this.popoverElement.setAttribute("locale",o.locale),this.popoverElement.setAttribute(this.ATTRIBUTE_FONT_STYLE,l),this.popoverElement.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,c),this.popoverElement.setAttribute(this.ATTRIBUTE_THEME,this.getAttribute(this.ATTRIBUTE_THEME)),document.body.appendChild(this.popoverElement),this.popoverElement.popoverData={channel:n,grade:i},this.wrapper.classList.add("highlighted"),setTimeout((()=>{const e=this.mouseOver,s=()=>"ontouchstart"in window||navigator.maxTouchPoints>0,r=t?.isKeyboardTriggered||!1,i=()=>{this.hidePopover(this.wrapper),document.removeEventListener("click",i),window.removeEventListener("resize",i)};e||s()||r?this.wrapper.classList.contains("highlighted")&&s()&&(document.addEventListener("click",i),window.addEventListener("resize",i)):this.hidePopover(this.wrapper)}),200)}};hidePopover=t=>{this.mouseOver=!1,this.popoverElement?.remove(),this.popoverElement=null,t.classList.remove("highlighted")};addCssStyle(t){const e=document.createElement("style");e.setAttribute("type","text/css"),e.innerHTML=`@import "${t}/index.css"`,this.shadowRoot?.appendChild(e)}addRootElement(){const t=document.createElement("div");return t.classList.add("product-star-widget"),this.shadowRoot?.appendChild(t),t}async getBaseUrl(e){if(!e)return".";const s=await t(`${e}/LATEST_VERSION`);return e.replace(this.CURRENT_MAJOR_VERSION,s.trim())||"."}static getDistributionUrl(t){return t&&"."!==t?new URL(t).origin:t}async render(){if(!this.shadowRoot)return;const{baseUrl:t,configuration:e,theme:s}=this.context,r=this.context.grade.count,n=0===r,a=e.locale,o=n?0:this.context.grade.rating,l=n?"":`\n          <span class="grade"> ${i(a,o,2,2)} </span>\n          <span class="count"> (${i(a,r)}) </span>\n        `;this.rootElement.innerHTML=`\n      <div class="wrapper" tabindex="1">\n        <etrusted-ps-star-rating\n          baseUrl="${t}"\n          rating="${o}"\n          theme="${s}"\n        ></etrusted-ps-star-rating>\n        ${l}\n      </div>\n    `,this.wrapper=this.rootElement.querySelector(".wrapper"),n||this.wrapper&&(this.wrapper.onmouseenter=this.showPopover,this.wrapper.addEventListener("focus",(()=>{if(this.popoverElement)return;const t=new Event("mouseenter");t.isKeyboardTriggered=!0,this.wrapper.dispatchEvent(t)})),this.wrapper.addEventListener("focusout",(()=>{this.wrapper.dispatchEvent(new Event("mouseleave"))})),this.keyboardNaivgationOrder.setOrder([this.wrapper],0),this.keyboardNaivgationOrder.addListener(this.wrapper))}};C=y=function(t,e,s,r){var i,n=arguments.length,a=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,r);else for(var o=t.length-1;o>=0;o--)(i=t[o])&&(a=(n<3?i(a):n>3?i(e,s,a):i(e,s))||a);return n>3&&a&&Object.defineProperty(e,s,a),a}([h({selector:"etrusted-product-star-widget"})],C)})();